<html>
    <head>
        <title>Simplified Media Center</title>
    </head>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        var cur_dir = "";

        function change_dir(new_dir){
            return function(){

                if(new_dir !== '..'){
                    var path_lst = new_dir.split('/');
                    path_lst = path_lst.filter(x => x !== ''); 
                    cur_dir = path_lst.join('/');
                }else{
                    var path_lst = cur_dir.split('/');
                    path_lst = path_lst.filter(x => x !== ''); 
                    path_lst.pop();
                    cur_dir = path_lst.join('/');
                }
                
                load_dir()
            }
        }
        
        function load_dir(){
            socket.emit("load_dir", cur_dir);     
        }

        window.onload = load_dir;

        function load_media(media_url){
            return function() {
                socket.emit("load", media_url)
            };
        }
    
        function test(arg){
            return function() {console.log("howdy test " + arg)};
        }

        socket.on("dir_data", function(data){
            //console.log(data);

                
            var ul = document.getElementById("media_list");
            ul.innerHTML = "";

            if(cur_dir !== ''){
                var li = document.createElement("li");
                var media_button = document.createElement("button");
                    
                media_button.addEventListener('click', change_dir(".."));
                
                media_button.appendChild(document.createTextNode("Back"));
                li.appendChild(media_button);
                ul.appendChild(li);
            } 

            for (var key in data){
                var li = document.createElement("li");
                var media_button = document.createElement("button");
                
                if(data.hasOwnProperty(key)){
                     
                    if(data[key]){
                        var new_dir = cur_dir + "/" + key;
                        media_button.addEventListener('click', change_dir(new_dir));
                    } else {
                        var media_url = cur_dir + "/" + key;
                        console.log(key);
                        //media_button.onclick = load_media(media_url);
                        media_button.addEventListener('click', load_media(media_url));
                    }

                    media_button.appendChild(document.createTextNode(key));
                    li.appendChild(media_button);
                    ul.appendChild(li);
                }
            }
        });


        function search_submit(){
            var query = document.getElementById("search_text").value;
            console.log(query);

            socket.emit("query", query)
        }

        socket.on("play", function(media_url){
            console.log(media_url);
            var viewer = document.getElementById("play_viewer");
            var viewer_src = document.getElementById("source_viewer");
            console.log(media_url);
            viewer_src.src = media_url;

            viewer.load();
        })

    </script>

    <body>
        <div id="search_bar">
            <input type="text" id="search_text" placeholder="howdy">
            <button type="button" onclick="search_submit()">Search</button>
        </div>

        <div id="media_list_container">
            <ul id="media_list">
            </ul>
        </div>
        <div id="media_viewer_container">
            <video id="play_viewer" controls autoplay width=200 heigh=500>
                <source id="source_viewer" src="/video/videos/sample.mp4" type="video/mp4">
            </video> 
        </div>
    </body>
</html>
